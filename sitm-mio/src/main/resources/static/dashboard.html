<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SITM-MIO Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 5px;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 18px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .stat {
        margin: 10px 0;
      }

      .stat-label {
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #667eea;
        margin-top: 5px;
      }

      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
      }

      .btn-secondary {
        background: #48bb78;
        color: white;
      }

      .btn-secondary:hover {
        background: #38a169;
      }

      .btn-danger {
        background: #f56565;
        color: white;
      }

      .btn-danger:hover {
        background: #e53e3e;
      }

      input,
      select {
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 5px;
        font-size: 14px;
        flex: 1;
        min-width: 200px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .log {
        background: #1a202c;
        color: #48bb78;
        padding: 15px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }

      .log-entry {
        margin: 5px 0;
      }

      .log-entry.error {
        color: #f56565;
      }

      .log-entry.success {
        color: #48bb78;
      }

      .log-entry.info {
        color: #4299e1;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      th {
        background: #f7fafc;
        font-weight: bold;
        color: #2d3748;
      }

      tr:hover {
        background: #f7fafc;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .status-active {
        background: #c6f6d5;
        color: #22543d;
      }

      .status-inactive {
        background: #fed7d7;
        color: #742a2a;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        background: white;
        border: none;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
        font-weight: bold;
        color: #666;
      }

      .tab.active {
        background: #667eea;
        color: white;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üöå SITM-MIO Dashboard</h1>
        <p class="subtitle">
          Sistema Integrado de Transporte Masivo - Monitoreo en Tiempo Real
        </p>
      </header>

      <!-- Estad√≠sticas del Sistema -->
      <div class="grid">
        <div class="card">
          <h2>üìä Estad√≠sticas del Sistema</h2>
          <div class="stat">
            <div class="stat-label">Workers Activos</div>
            <div class="stat-value" id="workers-count">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Registros Procesados</div>
            <div class="stat-value" id="records-count">-</div>
          </div>
          <div class="stat">
            <div class="stat-label">Velocidad Promedio</div>
            <div class="stat-value" id="avg-velocity">-</div>
          </div>
        </div>

        <div class="card">
          <h2>üîß Estado del Sistema</h2>
          <div class="stat">
            <div class="stat-label">Estado del Master</div>
            <div class="stat-value" style="font-size: 16px" id="master-status">
              -
            </div>
          </div>
          <div style="margin-top: 20px">
            <button class="btn-primary" onclick="loadStats()">
              üîÑ Actualizar
            </button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('historical')">
          üìö Procesamiento Hist√≥rico
        </button>
        <button class="tab" onclick="switchTab('streaming')">
          üì° Streaming Simulado
        </button>
        <button class="tab" onclick="switchTab('results')">
          üìä Resultados
        </button>
      </div>

      <!-- Contenido: Procesamiento Hist√≥rico -->
      <div id="tab-historical" class="tab-content active">
        <div class="card">
          <h2>üìö Procesar Datos Hist√≥ricos</h2>
          <div class="controls">
            <input
              type="text"
              id="historical-file"
              placeholder="Ruta del archivo CSV (ej: ./data/archivo.csv)"
              value="./data/muestra_datos.csv"
            />
            <input
              type="text"
              id="historical-label"
              placeholder="Etiqueta del test (ej: TEST_1M)"
              value="TEST_HISTORICAL"
            />
            <input
              type="number"
              id="historical-batch"
              placeholder="Tama√±o de lote"
              value="10000"
            />
            <button class="btn-primary" onclick="processHistorical()">
              ‚ñ∂Ô∏è Procesar
            </button>
          </div>
          <div class="log" id="historical-log">
            <div class="log-entry info">
              üí° Listo para procesar datos hist√≥ricos...
            </div>
          </div>
        </div>
      </div>

      <!-- Contenido: Streaming -->
      <div id="tab-streaming" class="tab-content">
        <div class="card">
          <h2>üì° Streaming Simulado en Tiempo Real</h2>
          <div class="controls">
            <input
              type="text"
              id="streaming-file"
              placeholder="Ruta del archivo CSV"
              value="./data/muestra_datos.csv"
            />
            <input
              type="number"
              id="streaming-interval"
              placeholder="Intervalo (ms)"
              value="1000"
            />
            <input
              type="number"
              id="streaming-window"
              placeholder="Tama√±o de ventana"
              value="100"
            />
            <button class="btn-secondary" onclick="startStreaming()">
              ‚ñ∂Ô∏è Iniciar
            </button>
            <button class="btn-danger" onclick="stopStreaming()">
              ‚èπÔ∏è Detener
            </button>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="streaming-progress"
              style="width: 0%"
            >
              0%
            </div>
          </div>
          <div class="log" id="streaming-log">
            <div class="log-entry info">üí° Listo para iniciar streaming...</div>
          </div>
        </div>
      </div>

      <!-- Contenido: Resultados -->
      <div id="tab-results" class="tab-content">
        <div class="card">
          <h2>üìä √öltimos Resultados</h2>
          <div class="controls">
            <select id="results-test">
              <option value="">Todos los tests</option>
            </select>
            <button class="btn-primary" onclick="loadResults()">
              üîÑ Cargar Resultados
            </button>
          </div>
          <div style="max-height: 400px; overflow-y: auto; margin-top: 20px">
            <table id="results-table">
              <thead>
                <tr>
                  <th>Arco ID</th>
                  <th>L√≠nea</th>
                  <th>Velocidad (km/h)</th>
                  <th>Muestras</th>
                  <th>Test</th>
                </tr>
              </thead>
              <tbody id="results-body">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px">
                    No hay datos disponibles. Procesa datos primero.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuraci√≥n de la API
      const API_BASE = "http://localhost:8080/api";
      const WS_URL = "ws://localhost:8080/ws/streaming";
      let ws = null;

      // Cargar estad√≠sticas
      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE}/data/stats`);
          const result = await response.json();

          if (result.success && result.data) {
            const data = result.data;
            document.getElementById("workers-count").textContent =
              data.activeWorkers || 0;
            document.getElementById("records-count").textContent = (
              data.totalVelocityRecords || 0
            ).toLocaleString();
            document.getElementById("avg-velocity").textContent =
              (data.avgVelocityKmh || 0).toFixed(1) + " km/h";
            document.getElementById("master-status").textContent =
              data.systemStatus || "Desconocido";
          }
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      // Procesar datos hist√≥ricos
      async function processHistorical() {
        const filePath = document.getElementById("historical-file").value;
        const testLabel = document.getElementById("historical-label").value;
        const batchSize = parseInt(
          document.getElementById("historical-batch").value
        );

        if (!filePath || !testLabel) {
          addLog(
            "historical-log",
            "error",
            "‚ùå Por favor completa todos los campos"
          );
          return;
        }

        addLog("historical-log", "info", "‚è≥ Iniciando procesamiento...");

        try {
          const response = await fetch(`${API_BASE}/historical/process`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              dataFilePath: filePath,
              testLabel: testLabel,
              batchSize: batchSize,
              maxRecords: null,
            }),
          });

          const result = await response.json();

          if (result.success) {
            const data = result.data;
            addLog(
              "historical-log",
              "success",
              `‚úÖ Procesamiento completado: ${data.totalRecords} registros en ${data.processingTimeMs}ms`
            );
            addLog(
              "historical-log",
              "success",
              `   Resultados v√°lidos: ${data.validResults}, Lotes: ${data.batchCount}`
            );
            addLog(
              "historical-log",
              "success",
              `   Throughput: ${data.throughputDps?.toFixed(2)} datagramas/seg`
            );
            loadStats();
          } else {
            addLog("historical-log", "error", `‚ùå Error: ${result.error}`);
          }
        } catch (error) {
          addLog("historical-log", "error", `‚ùå Error: ${error.message}`);
        }
      }

      // Iniciar streaming
      function startStreaming() {
        const filePath = document.getElementById("streaming-file").value;
        const intervalMs = parseInt(
          document.getElementById("streaming-interval").value
        );
        const windowSize = parseInt(
          document.getElementById("streaming-window").value
        );

        if (!filePath) {
          addLog(
            "streaming-log",
            "error",
            "‚ùå Por favor ingresa la ruta del archivo"
          );
          return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
          addLog("streaming-log", "error", "‚ùå Streaming ya est√° activo");
          return;
        }

        // Conectar WebSocket
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
          addLog(
            "streaming-log",
            "success",
            "üîå Conectado al servidor WebSocket"
          );

          // Enviar comando de inicio
          ws.send(
            JSON.stringify({
              action: "start",
              filePath: filePath,
              intervalMs: intervalMs,
              windowSize: windowSize,
            })
          );
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);

          if (message.type === "streaming_started") {
            addLog(
              "streaming-log",
              "success",
              `‚úÖ Streaming iniciado: ${message.totalRecords} registros`
            );
          } else if (message.type === "streaming_data") {
            const progress = message.progress.toFixed(1);
            document.getElementById("streaming-progress").style.width =
              progress + "%";
            document.getElementById("streaming-progress").textContent =
              progress + "%";

            addLog(
              "streaming-log",
              "info",
              `üìä Ventana ${message.windowIndex}: ${message.recordsProcessed} registros, ` +
                `${message.validResults} resultados v√°lidos (${progress}%)`
            );
          } else if (message.type === "streaming_completed") {
            addLog(
              "streaming-log",
              "success",
              `‚úÖ Streaming completado: ${message.totalWindows} ventanas procesadas`
            );
            document.getElementById("streaming-progress").style.width = "100%";
            document.getElementById("streaming-progress").textContent = "100%";
            loadStats();
          } else if (message.type === "error") {
            addLog("streaming-log", "error", `‚ùå Error: ${message.error}`);
          }
        };

        ws.onerror = (error) => {
          addLog("streaming-log", "error", "‚ùå Error de conexi√≥n WebSocket");
        };

        ws.onclose = () => {
          addLog("streaming-log", "info", "üîå Desconectado del servidor");
        };
      }

      // Detener streaming
      function stopStreaming() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: "stop" }));
          ws.close();
          addLog("streaming-log", "info", "‚èπÔ∏è Streaming detenido");
        }
      }

      // Cargar resultados
      async function loadResults() {
        const testLabel = document.getElementById("results-test").value;

        try {
          let url = `${API_BASE}/data/velocities/top?limit=50`;
          if (testLabel) {
            url += `&testLabel=${testLabel}`;
          }

          const response = await fetch(url);
          const result = await response.json();

          if (result.success && result.data) {
            const tbody = document.getElementById("results-body");
            tbody.innerHTML = "";

            result.data.forEach((item) => {
              const row = tbody.insertRow();
              row.insertCell(0).textContent = item.arcId;
              row.insertCell(1).textContent = item.lineId || "-";
              row.insertCell(2).textContent = item.velocityKmh.toFixed(2);
              row.insertCell(3).textContent = item.sampleCount;
              row.insertCell(4).textContent = item.testLabel;
            });
          } else {
            console.error("Error loading results:", result.error);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // Cargar lista de tests
      async function loadTests() {
        try {
          const response = await fetch(`${API_BASE}/data/tests`);
          const result = await response.json();

          if (result.success && result.data) {
            const select = document.getElementById("results-test");
            select.innerHTML = '<option value="">Todos los tests</option>';

            result.data.forEach((test) => {
              const option = document.createElement("option");
              option.value = test;
              option.textContent = test;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Error loading tests:", error);
        }
      }

      // Cambiar de tab
      function switchTab(tabName) {
        // Desactivar todos los tabs
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Activar el tab seleccionado
        document
          .querySelector(`.tab[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
        document.getElementById(`tab-${tabName}`).classList.add("active");

        // Cargar datos si es necesario
        if (tabName === "results") {
          loadTests();
          loadResults();
        }
      }

      // Agregar entrada al log
      function addLog(logId, type, message) {
        const log = document.getElementById(logId);
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      // Inicializaci√≥n
      loadStats();
      setInterval(loadStats, 5000); // Actualizar cada 5 segundos
    </script>
  </body>
</html>
